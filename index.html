<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Just Another Codes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Just Another Codes">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Just Another Codes">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just Another Codes">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Just Another Codes" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://ww2.sinaimg.cn/mw690/68e34b55gw1eh6usw90fyj203k03kgln.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">WilliamChen</a></h1>
		</hgroup>

		
		<p class="header-subtitle">随便写着</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/novono" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">就这么样子，毕业好几年了</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">WilliamChen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://ww2.sinaimg.cn/mw690/68e34b55gw1eh6usw90fyj203k03kgln.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">WilliamChen</h1>
			</hgroup>
			
			<p class="header-subtitle">随便写着</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/novono" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-NFC知识点整理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/03/NFC知识点整理/" class="article-date">
  	<time datetime="2015-08-03T13:46:59.964Z" itemprop="datePublished">2015-08-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/03/NFC知识点整理/">NFC知识点整理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>又开始了愉快的一周，为了准备分享，所以只能趁着现在把之前的一些知识点做下整理<br>首先是写在公司博客的一些内容：<br>1、卡的类型<br>手头供应商为NXP，所以给的卡就是Mifare Classic/Plus/Desfire/UtrilLight，已经基本覆盖所有NXP的卡片类型，剩下的区别就是容量和加密类型区别而已<br>2、关于Classic类型的卡<br>NFC芯片存在一个EEPROM的区域，里面分为了几个区域，我们通过指令进行不同区域的读写加密<br>3、关于工卡<br>某厂工卡使用Classic类型的卡片，此类型卡已经有专门破解的硬件了。<br>已经能够批量复制工卡。<br>4、涉及的协议：ISO/IEC 14443A（1~4），ISO 7816（APDU，此为命令），部分卡片或者读卡器会有一些私有的指令<br>5、安全，Plus S使用AES，Desfire也有更高级的加密，其他的即使有也形同虚设。银行卡级别的使用了一个叫做SE的加密模块，这个需要硬件支持。目前用在sim卡、银行卡等场景<br>6、能否用NFC Android模拟一张卡？<br>这个叫做HCE(Host-based Card Emulation) ，Android4.4后支持，但支持的协议仅有： ISO/IEC 7816-4 over ISO-DEP (ISO/IEC 14443-4)<br>此处有一老外的回答：</p>
<p>Speculations on why they decided that way:</p>
<p>First of all, ISO/IEC 7816-4 over ISO-DEP is the highes protocol layer that could be used to route communication to the application processor through NCI (NFC Controller Interface). Routing lower protocol layers is possible (read: “the NCI protocol supports this”), though there is no need for the NFC controller to even support routing of lower layer communication.<br>ISO/IEC 7816-4 over ISO-DEP permits routing on a per-application basis. I.e. the reader selects a specific application and only then, the NFC controller decides if the communication is passed to a secure element or to the application processor. The application processor can perform a similar routing mechanism to route communication to a specific app (that’s what’s done on Android now).<br>Using lower protocol layers (e.g. ISO/IEC 14443-3) there is no way of doing per-application routing. Instead all communication on that level would be routed to either a secure element or to the application processor. If routed to the application processor, then the operating system has no means to choose between multiple apps. Instead only one app could be registered for that type of communication. However, considering the multitude of app developers for a platform like Android, permitting only a single app would be rather inhibiting development.<br>MIFARE Classic is proprietary technology from NXP. I don’t expect them to license a pure software implementation (on the application processor/Android system) of the MIFARE Classic protocol/tag platform.<br>MIFARE Classic uses non-standard framing for authentication commands, so it might be difficult to emulate over the NCI Frame RF interface (though I’m not sufficiently familiar with that protocol to confirm if there’s an actual limitation that prevents MF Classic emulation).</p>
<p>简而言之，Google家只想支持最新的协议的卡片，classic之类的就算了吧</p>
<p>7、项目的最后产生了一个库，现在只能支持mifare S50的，后续陆续支持其他卡片<br>8、一个可以界面的项目：<a href="https://github.com/ikarus23/MifareClassicTool" target="_blank" rel="external">https://github.com/ikarus23/MifareClassicTool</a><br>9、一些android不支持的卡片，可以通过用java重写一遍该卡片的linux驱动来实现，和当年重新BLE的协议代码一样，想想当年，还真可怜，还好这次需求没说要支持</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-android事件注入" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/02/android事件注入/" class="article-date">
  	<time datetime="2015-08-02T08:46:48.355Z" itemprop="datePublished">2015-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/android事件注入/">android事件注入</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>另外一个伤感的问题，测试的同学发现了一个概率性问题。<br>OK，那就抓Log，发现是那个RandomAccessFile抛出IO Exception<br>那就在挂掉的地方重新来一次呗，改完<br>如何测试？？？<br>本来切通道和唤出菜单都是有广播和按键事件可以利用的，写了一个小小的服务。<br>后来想起，实际上可以通过sendevent /dev/input/event0 进行模拟、按键事件的注入，随查询了一下abs的代码，发现一点坑的问题，这个语法太复杂<br>举例：</p>
<pre><code><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span>   ABS_MT_TOUCH_MAJOR = <span class="string">"0x30"</span>; <span class="comment">/* Major axis of touching ellipse */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_TOUCH_MINOR = <span class="string">"0x31"</span>; <span class="comment">/* Minor axis (omit if circular) */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_WIDTH_MAJOR = <span class="string">"0x32"</span>; <span class="comment">/* Major axis of approaching ellipse */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_WIDTH_MINOR = <span class="string">"0x33"</span>; <span class="comment">/* Minor axis (omit if circular) */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_ORIENTATION = <span class="string">"0x34"</span>; <span class="comment">/* Ellipse orientation */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_POSITION_X = <span class="string">"0x35"</span>;<span class="comment">/* Center X ellipse position */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_POSITION_Y = <span class="string">"0x36"</span>; <span class="comment">/* Center Y ellipse position */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_TOOL_TYPE = <span class="string">"0x37"</span>; <span class="comment">/* Type of touching device (finger, pen, ...) */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_BLOB_ID = <span class="string">"0x38"</span>; <span class="comment">/* Group a set of packets as a blob */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_TRACKING_ID = <span class="string">"0x39"</span>; <span class="comment">/* Unique ID of initiated contact */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_PRESSURE = <span class="string">"0x3a"</span>; <span class="comment">/* Pressure on contact area */</span>
</code></pre><p>以上是ABS事件的所有命令，后面查了一下一篇文章<br><a href="http://blog.csdn.net/xbalien29/article/details/12977047" target="_blank" rel="external">http://blog.csdn.net/xbalien29/article/details/12977047</a></p>
<pre><code><span class="number">0003</span> <span class="number">0035</span> <span class="number">0000008</span>b
<span class="number">0003</span> <span class="number">0036</span> <span class="number">000002</span>c0
<span class="number">0003</span> <span class="number">0030</span> <span class="number">00000044</span>
<span class="number">0003</span> <span class="number">0032</span> <span class="number">00000004</span>
<span class="number">0003</span> <span class="number">0039</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0002</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0000</span> <span class="number">00000000</span>
<span class="number">0003</span> <span class="number">0035</span> <span class="number">0000008</span>b
<span class="number">0003</span> <span class="number">0036</span> <span class="number">000002</span>c0
<span class="number">0003</span> <span class="number">0030</span> <span class="number">00000000</span>
<span class="number">0003</span> <span class="number">0032</span> <span class="number">00000001</span>
<span class="number">0003</span> <span class="number">0039</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0002</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0000</span> <span class="number">00000000</span>
</code></pre><p>这是一个点击事件的命令！<br>开动大脑，开始读Monkey代码：/development/cmds/monkey<br>这是一份还不错的代码，实际上是采用了IWindowManager中的injectKeyEvent等方法，同样的，触摸事件是通过类似的injectMotionEvent实现。<br>随之，抽离代码<br>形成了一个库，给后来人调用<br>写了一个服务，不断地帮我点击某个地方，按按键。<br>至于背后的方法injectKeyEvent在系统中是如何注入的呢？且听下回分解<br>我那跑了一夜的代码</p>
<pre><code><span class="comment">/**
 * @file SwitchService.java
 * @author chenweilin
 * @brief  触摸和按键模拟服务
 * @date 2015-7-15 create
 *
 */</span>
<span class="keyword">public</span> <span class="keyword">class</span> DemoService extends Service {
    @<span class="function">Override
    <span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent arg0)</span> </span>{
        <span class="keyword">return</span> null;
    }

    <span class="keyword">private</span> <span class="keyword">int</span> mVerbose = <span class="number">1</span>;
    <span class="keyword">private</span> IActivityManager mAm;
    <span class="keyword">private</span> IWindowManager mWm;
    <span class="keyword">private</span> Random mRandom;


    @<span class="function">Override
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>{
        super.onCreate();
        getSystemInterfaces();
        mRandom = <span class="keyword">new</span> Random();
        SwitchThread switchThread = <span class="keyword">new</span> SwitchThread();
        switchThread.start();
    }
    <span class="keyword">class</span> SwitchThread extends Thread {
        @<span class="function">Override
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{
            <span class="keyword">while</span> (<span class="literal">true</span>) {
                callTouchMenuAndClick(<span class="number">408</span>,<span class="number">303</span>);<span class="comment">//点击某个地方</span>
                callTouchMenuAndClick(<span class="number">471</span>,<span class="number">296</span>);<span class="comment">//点击某个地方</span>
                callTouchMenuAndClick(<span class="number">535</span>,<span class="number">296</span>);<span class="comment">//点击某个地方</span>
            }
        }
    }


    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callTouchMenuAndClick</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>{
        <span class="keyword">int</span> time = mRandom.nextInt(<span class="number">1500</span>)%(<span class="number">1500</span>-<span class="number">700</span>+<span class="number">1</span>) + <span class="number">700</span>;<span class="comment">//点击间隔时间随机</span>
        injectKeyDown(KeyEvent.KEYCODE_TV_INPUT);
        <span class="keyword">try</span> {
            Thread.sleep(time);
        } <span class="keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        injectClick(x, y);
        time = mRandom.nextInt(<span class="number">10000</span>)%(<span class="number">10000</span>-<span class="number">4000</span>+<span class="number">1</span>) + <span class="number">4000</span>;
        <span class="keyword">try</span> {
            Thread.sleep(time);
        } <span class="keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }


    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectClick</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>{
        MonkeyTouchEvent monkeyTouchEvent = <span class="keyword">new</span> MonkeyTouchEvent(MotionEvent.ACTION_DOWN);
        monkeyTouchEvent.addPointer(<span class="number">0</span>, x, y);
        monkeyTouchEvent.injectEvent(mWm, mAm, mVerbose);
        <span class="keyword">try</span> {
            Thread.sleep(<span class="number">200</span>);
        } <span class="keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        monkeyTouchEvent = <span class="keyword">new</span> MonkeyTouchEvent(MotionEvent.ACTION_UP);
        monkeyTouchEvent.addPointer(<span class="number">0</span>, x, y);
        monkeyTouchEvent.injectEvent(mWm, mAm, mVerbose);
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectKeyDown</span><span class="params">(<span class="keyword">int</span> keycode)</span></span>{
        MonkeyKeyEvent monkeyKeyEvent = <span class="keyword">new</span> MonkeyKeyEvent(KeyEvent.ACTION_DOWN, keycode);
        monkeyKeyEvent.injectEvent(mWm, mAm, mVerbose);
    }

    <span class="function"><span class="keyword">private</span> boolean <span class="title">getSystemInterfaces</span><span class="params">()</span> </span>{
        mAm = ActivityManagerNative.getDefault();
        <span class="keyword">if</span> (mAm == null) {
            System.err.println(<span class="string">"** Error: Unable to connect to activity manager; is the system "</span>
                    + <span class="string">"running?"</span>);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        mWm = IWindowManager.Stub.asInterface(ServiceManager.getService(<span class="string">"window"</span>));
        <span class="keyword">if</span> (mWm == null) {
            System.err.println(<span class="string">"** Error: Unable to connect to window manager; is the system "</span>
                    + <span class="string">"running?"</span>);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
    }
}
</code></pre><p>Monkey中的实现</p>
<pre><code>@<span class="function">Override
<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">injectEvent</span>(<span class="params">IWindowManager iwm, IActivityManager iam, <span class="keyword">int</span> verbose</span>) </span>{
    <span class="keyword">if</span> (verbose &gt; <span class="number">1</span>) {
        String note;
        <span class="keyword">if</span> (mAction == KeyEvent.ACTION_UP) {
            note = <span class="string">"ACTION_UP"</span>;
        } <span class="keyword">else</span> {
            note = <span class="string">"ACTION_DOWN"</span>;
        }
        <span class="keyword">try</span> {
            System.<span class="keyword">out</span>.println(<span class="string">":Sending Key ("</span> + note + <span class="string">"): "</span>
                    + mKeyCode + <span class="string">"    // "</span>
                    + MonkeySourceRandom.getKeyName(mKeyCode));
        } <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
            System.<span class="keyword">out</span>.println(<span class="string">":Sending Key ("</span> + note + <span class="string">"): "</span>
                    + mKeyCode + <span class="string">"    // Unknown key event"</span>);
        }
    }
    <span class="comment">// inject key event</span>
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (!iwm.injectKeyEvent(getEvent(), <span class="keyword">false</span>)) {<span class="comment">//这里背后应该有另外一篇博文产出，需要读系统源码了</span>
            <span class="keyword">return</span> MonkeyEvent.INJECT_FAIL;
        }
    } <span class="keyword">catch</span> (RemoteException ex) {
        <span class="keyword">return</span> MonkeyEvent.INJECT_ERROR_REMOTE_EXCEPTION;
    }
    <span class="keyword">return</span> MonkeyEvent.INJECT_SUCCESS;
}
</code></pre><p>后记：<br>实际上可以写一个简单的脚本进行事件的注入，实现自动化测试<br>所以，这就成了给实习生玩的一个项目</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-adb源码初读" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/02/adb源码初读/" class="article-date">
  	<time datetime="2015-08-02T08:27:48.651Z" itemprop="datePublished">2015-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/adb源码初读/">adb源码初读</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先上一张图片，这是adb通信的时候的主要模块</p>
<p><img src="/img/15-8-adb_main.png" alt="adb_main"></p>
<p>Host即主机，在实际操作中，可以把电脑，android主机当做Host，使用adb命令连接即可<br>主机内会开启一个Server，通过TCP进行内部的通信，adb-client即用户输入界面之类的。而客户端中跑的是一个叫做adbd的东西，全称是：adb daemon 在android设备端的守护进程，看源码可以发现这货是随整机启动的。<br>下面是源码走读时间：路径位于：/system/core/adb，大家可以看到一些奇怪的标签ADB_HOST。。aha。。区分主从应用所用。。。先mm一番，会发现编译会生成主机端和客户端两个可执行文件：</p>
<pre><code><span class="string">Install:</span> out<span class="regexp">/target/</span>product<span class="regexp">/seewo/</span>system<span class="regexp">/bin/</span>adb 主机端的bin，可以直接在电脑执行
<span class="string">Install:</span> out<span class="regexp">/target/</span>product<span class="regexp">/seewo/</span>root<span class="regexp">/sbin/</span>adbd 客户端守护进程的bin
</code></pre><p>那么，如何解决通信问题呢？<br>看源码：commandline.c 这里就是处理Host端指令的地方，问我为什么知道？看mk文件，然后顺着读下来就行了。</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">adb_commandline</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>{

}
</code></pre><p>举例：</p>
<pre><code><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"connect"</span>)) {
        <span class="keyword">char</span> *tmp;
        <span class="keyword">if</span> (argc != <span class="number">2</span>) {
            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: adb connect &lt;host&gt;[:&lt;port&gt;]\n"</span>);
            <span class="keyword">return</span> <span class="number">1</span>;
        }
        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span> buf, <span class="string">"host:connect:%s"</span>, argv[<span class="number">1</span>]);
        tmp = adb_query(buf);
        <span class="keyword">if</span>(tmp) {
            <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, tmp);
            <span class="keyword">return</span> <span class="number">0</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="number">1</span>;
        }
    }
</code></pre><p>  //我试着写了一个，效果杠杠的</p>
<p>这里进行连接的判断<br>既然我们需要进行信息交换，那么类似的有adb logcat ，看这部分代码</p>
<pre><code><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"logcat"</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"lolcat"</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"longcat"</span>)) {
    <span class="keyword">return</span> logcat(ttype, serial, argc, argv);
}
</code></pre><p>// 之后是</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">logcat</span><span class="params">(transport_type transport, <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span>
</span>{
    <span class="keyword">char</span> buf[<span class="number">4096</span>];
    <span class="keyword">char</span> *log_tags;
    <span class="keyword">char</span> *quoted_log_tags;
    log_tags = getenv(<span class="string">"ANDROID_LOG_TAGS"</span>);
    quoted_log_tags = dupAndQuote(log_tags == <span class="literal">NULL</span> ? <span class="string">""</span> : log_tags);
    <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf),
        <span class="string">"shell:export ANDROID_LOG_TAGS=\"\%s\" ; exec logcat"</span>,
        quoted_log_tags);
    <span class="built_in">free</span>(quoted_log_tags);
    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"longcat"</span>)) {
        <span class="built_in">strncat</span>(buf, <span class="string">" -v long"</span>, <span class="keyword">sizeof</span>(buf)-<span class="number">1</span>);
    }
    argc -= <span class="number">1</span>;
    argv += <span class="number">1</span>;
    <span class="keyword">while</span>(argc-- &gt; <span class="number">0</span>) {
        <span class="keyword">char</span> *quoted;
        quoted = dupAndQuote (*argv++);
        <span class="built_in">strncat</span>(buf, <span class="string">" "</span>, <span class="keyword">sizeof</span>(buf)-<span class="number">1</span>);
        <span class="built_in">strncat</span>(buf, quoted, <span class="keyword">sizeof</span>(buf)-<span class="number">1</span>);
        <span class="built_in">free</span>(quoted);
    }
    send_shellcommand(transport, serial, buf);<span class="comment">//实际最终执行的地方</span>
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>//之后是：</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">send_shellcommand</span><span class="params">(transport_type transport, <span class="keyword">char</span>* serial, <span class="keyword">char</span>* buf)</span>
</span>{
    <span class="keyword">int</span> fd, ret;
    <span class="keyword">for</span>(;;) {
        fd = adb_connect(buf);<span class="comment">//如果没连接则等待设备</span>
        <span class="keyword">if</span>(fd &gt;= <span class="number">0</span>)
            <span class="keyword">break</span>;
        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"- waiting for device -\n"</span>);<span class="comment">//是不是觉得这句话很眼熟</span>
        adb_sleep_ms(<span class="number">1000</span>);
        do_cmd(transport, serial, <span class="string">"wait-for-device"</span>, <span class="number">0</span>);<span class="comment">//真的去等设备了，等到心碎，而且会滚回去开头的那个函数</span>
    }
    read_and_dump(fd);<span class="comment">//重点来了，后面读这里</span>
    ret = adb_close(fd);
    <span class="keyword">if</span> (ret)
        perror(<span class="string">"close"</span>);
    <span class="keyword">return</span> ret;
}
</code></pre><p>//读取Log的地方</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read_and_dump</span><span class="params">(<span class="keyword">int</span> fd)</span>
</span>{
    <span class="keyword">char</span> buf[<span class="number">4096</span>];
    <span class="keyword">int</span> len;
    <span class="keyword">while</span>(fd &gt;= <span class="number">0</span>) {
        D(<span class="string">"read_and_dump(): pre adb_read(fd=%d)\n"</span>, fd);<span class="comment">//可以尝试把这个打印打开，你就知道怎么回事了</span>
        len = adb_read(fd, buf, <span class="number">4096</span>);<span class="comment">//实际上还是读取USB设备写过来的数据</span>
        D(<span class="string">"read_and_dump(): post adb_read(fd=%d): len=%d\n"</span>, fd, len);
        <span class="keyword">if</span>(len == <span class="number">0</span>) {
            <span class="keyword">break</span>;
        }
        <span class="keyword">if</span>(len &lt; <span class="number">0</span>) {
            <span class="keyword">if</span>(errno == EINTR) <span class="keyword">continue</span>;
            <span class="keyword">break</span>;
        }
        fwrite(buf, <span class="number">1</span>, len, <span class="built_in">stdout</span>);
        fflush(<span class="built_in">stdout</span>);
    }
}
</code></pre><p>这个时候问题来了，如何实现从设备向主设备发送消息呢？</p>
<pre><code>adb Logcat <span class="operator">-s</span> “something”
</code></pre><p>over</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/02/hello-world/" class="article-date">
  	<time datetime="2015-08-02T07:05:42.698Z" itemprop="datePublished">2015-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 WilliamChen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>