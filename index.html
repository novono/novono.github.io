<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Just Another Codes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Just Another Codes">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Just Another Codes">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just Another Codes">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Just Another Codes" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://ww2.sinaimg.cn/mw690/68e34b55gw1eh6usw90fyj203k03kgln.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">WilliamChen</a></h1>
		</hgroup>

		
		<p class="header-subtitle">随便写着</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/novono" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/chen-wei-lin-56" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">四年级的Android软件工程师，兴趣是捣鼓一些小硬件</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">WilliamChen</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://ww2.sinaimg.cn/mw690/68e34b55gw1eh6usw90fyj203k03kgln.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">WilliamChen</h1>
			</hgroup>
			
			<p class="header-subtitle">随便写着</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/novono" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/chen-wei-lin-56" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-uesless-Android类加载器" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/31/uesless-Android类加载器/" class="article-date">
  	<time datetime="2015-08-31T13:02:15.747Z" itemprop="datePublished">2015-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/31/uesless-Android类加载器/">uesless-Android类加载器</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>虚拟机部分</p>
<p>  android/ics/libcore/dalvik</p>
<p>  ./src/main/java/dalvik/system/DexClassLoader.java</p>
<p>Extend the BaseDexClassLoader</p>
<p>  ./src/main/java/dalvik/system/BaseDexClassLoader.java</p>
<p>Extend from the ClassLoader, and the ClassLoader is the base JVM functions</p>
<p>所以可以看出，实际Android的方法依旧是继承自通用的类加载方法</p>
<p>下面看BaseDexClassLoader构造的实例：<br>public BaseDexClassLoader(String dexPath, File optimizedDirectory,  String libraryPath, ClassLoader parent)</p>
<p>dexPath the list of jar/apk files containing classes and resources</p>
<pre><code><span class="keyword">public</span> BaseDexClassLoader(<span class="keyword">String</span> dexPath, File optimizedDirectory,
        <span class="keyword">String</span> libraryPath, ClassLoader parent) {
    <span class="keyword">super</span>(parent);
    <span class="keyword">this</span>.pathList = <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);
}
</code></pre><p>/<em>* structured lists of path elements </em>/</p>
<p>此处应是将此路径的实例加入DexPathList中</p>
<pre><code><span class="annotation">@Override</span>
<span class="keyword">protected</span> <span class="function">URL <span class="title">findResource</span><span class="params">(String name)</span> </span>{
    <span class="function"><span class="keyword">return</span> pathList.<span class="title">findResource</span><span class="params">(name)</span></span>;
}

<span class="annotation">@Override</span>
<span class="keyword">protected</span> Enumeration&lt;URL&gt; findResources(String name) {
    <span class="function"><span class="keyword">return</span> pathList.<span class="title">findResources</span><span class="params">(name)</span></span>;
}

<span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function">String <span class="title">findLibrary</span><span class="params">(String name)</span> </span>{
    <span class="function"><span class="keyword">return</span> pathList.<span class="title">findLibrary</span><span class="params">(name)</span></span>;
}
</code></pre><p>此处实现了多种查找加载类中的方法<br>这个类在：./src/main/java/dalvik/system/DexPathList.java<br>从这个类中的注释可以看出，支持的文件格式还是比较多的。</p>
<pre><code><span class="comment">/**
 * A pair of lists of entries, associated with a {<span class="doctag">@code</span> ClassLoader}.
 * One of the lists is a dex/resource path &amp;mdash; typically referred
 * to as a "class path" &amp;mdash; list, and the other names directories
 * containing native code libraries. Class path entries may be any of:
 * a {<span class="doctag">@code</span> .jar} or {<span class="doctag">@code</span> .zip} file containing an optional
 * top-level {<span class="doctag">@code</span> classes.dex} file as well as arbitrary resources,
 * or a plain {<span class="doctag">@code</span> .dex} file (with no possibility of associated
 * resources).
 *
 * &lt;p&gt;This class also contains methods to use these lists to look up
 * classes and resources.&lt;/p&gt;
 */</span>
<span class="comment">/*package*/</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>{
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEX_SUFFIX = <span class="string">".dex"</span>;
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAR_SUFFIX = <span class="string">".jar"</span>;
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZIP_SUFFIX = <span class="string">".zip"</span>;
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APK_SUFFIX = <span class="string">".apk"</span>;
</code></pre><p>回到BaseDexClassLoader，实际上这个类只是继承了JVM中的ClassLoader，然后对其格式文件以及路径进行了限制和扩展</p>
<p>而PathClassLoader和DexClassLoader是对这个BaseDexClassLoader的继承</p>
<p>下面分析DexClassLoader：</p>
<pre><code>package dalvik.system;

import java.io.File;

/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> A class loader that loads classes from {<span class="comment">@code .jar} and {@code .apk} files</span>
 <span class="keyword">*</span> containing a {<span class="comment">@code classes.dex} entry. This can be used to execute code not</span>
 <span class="keyword">*</span> installed as part of an application.
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="variable">&lt;p&gt;</span>This class loader requires an application-private, writable directory to
 <span class="keyword">*</span> cache optimized classes. Use {<span class="comment">@code Context.getDir(String, int)} to create</span>
 <span class="keyword">*</span> such a directory: <span class="variable">&lt;pre&gt;</span>   {<span class="comment">@code</span>
 <span class="keyword">*</span>   File dexOutputDir = context.getDir(<span class="string">"dex"</span>, 0);
 <span class="keyword">*</span> }<span class="variable">&lt;/pre&gt;</span>
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="variable">&lt;p&gt;</span><span class="variable">&lt;strong&gt;</span>Do not cache optimized classes on external storage.<span class="variable">&lt;/strong&gt;</span>
 <span class="keyword">*</span> External storage does not provide access controls necessary to protect your
 <span class="keyword">*</span> application from code injection attacks.
 <span class="keyword">*</span>/
public class DexClassLoader extends BaseDexClassLoader {
    /<span class="keyword">*</span><span class="keyword">*</span>
     <span class="keyword">*</span> Creates a {<span class="comment">@code DexClassLoader} that finds interpreted and native</span>
     <span class="keyword">*</span> code.  Interpreted classes are found in a set of DEX files contained
     <span class="keyword">*</span> in Jar or APK files.
     <span class="keyword">*</span>
     <span class="keyword">*</span> <span class="variable">&lt;p&gt;</span>The path lists are separated using the character specified by the
     <span class="keyword">*</span> {<span class="comment">@code path.separator} system property, which defaults to {@code :}.</span>
     <span class="keyword">*</span>
     <span class="keyword">*</span> <span class="comment">@param dexPath the list of jar/apk files containing classes and</span>
     <span class="keyword">*</span>     resources, delimited by {<span class="comment">@code File.pathSeparator}, which</span>
     <span class="keyword">*</span>     defaults to {<span class="comment">@code ":"} on Android</span>
     <span class="keyword">*</span> <span class="comment">@param optimizedDirectory directory where optimized dex files</span>
     <span class="keyword">*</span>     should be written; must not be {<span class="comment">@code null}</span>
     <span class="keyword">*</span> <span class="comment">@param libraryPath the list of directories containing native</span>
     <span class="keyword">*</span>     libraries, delimited by {<span class="comment">@code File.pathSeparator}; may be</span>
     <span class="keyword">*</span>     {<span class="comment">@code null}</span>
     <span class="keyword">*</span> <span class="comment">@param parent the parent class loader</span>
     <span class="keyword">*</span>/
    public DexClassLoader(String dexPath, String optimizedDirectory,
            String libraryPath, ClassLoader parent) {
        super(dexPath, new File(optimizedDirectory), libraryPath, parent);
    }
}
</code></pre><p>这部分几乎没有对其父类进行重写，仅仅是增加一种加载某路径下的类文件的方法而已，所以可以看出，这个方法是能够对所有BaseDexClassLoader支持的类进行加载的</p>
<pre><code>package dalvik.system;

/**
 * Provides a simple {@link ClassLoader} implementation <span class="keyword">that</span> operates <span class="function_start"><span class="keyword">on</span></span> a <span class="type">list</span>
 * <span class="keyword">of</span> files <span class="keyword">and</span> directories <span class="keyword">in</span> <span class="keyword">the</span> <span class="keyword">local</span> <span class="type">file</span> system, <span class="keyword">but</span> <span class="keyword">does</span> <span class="keyword">not</span> attempt <span class="keyword">to</span>
 * load classes <span class="keyword">from</span> <span class="keyword">the</span> network. Android uses this <span class="type">class</span> <span class="keyword">for</span> <span class="keyword">its</span> system <span class="type">class</span>
 * loader <span class="keyword">and</span> <span class="keyword">for</span> <span class="keyword">its</span> <span class="type">application</span> <span class="type">class</span> loader(s).
 */
public <span class="type">class</span> PathClassLoader extends BaseDexClassLoader {
    /**
     * Creates a {@code PathClassLoader} <span class="keyword">that</span> operates <span class="function_start"><span class="keyword">on</span></span> a <span class="keyword">given</span> <span class="type">list</span> <span class="keyword">of</span> files
     * <span class="keyword">and</span> directories. This method <span class="keyword">is</span> equivalent <span class="keyword">to</span> calling
     * {@link <span class="comment">#PathClassLoader(String, String, ClassLoader)} with a</span>
     * {@code null} value <span class="keyword">for</span> <span class="keyword">the</span> <span class="keyword">second</span> argument (see description there).
     *
     * @param dexPath <span class="keyword">the</span> <span class="type">list</span> <span class="keyword">of</span> jar/apk files containing classes <span class="keyword">and</span>
     * resources, delimited <span class="keyword">by</span> {@code File.pathSeparator}, which
     * defaults <span class="keyword">to</span> {@code <span class="string">":"</span>} <span class="function_start"><span class="keyword">on</span></span> Android
     * @param parent <span class="keyword">the</span> parent <span class="type">class</span> loader
     */
    public PathClassLoader(String dexPath, ClassLoader parent) {
        super(dexPath, null, null, parent);
    }

    /**
     * Creates a {@code PathClassLoader} <span class="keyword">that</span> operates <span class="function_start"><span class="keyword">on</span></span> two <span class="keyword">given</span>
     * lists <span class="keyword">of</span> files <span class="keyword">and</span> directories. The entries <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">first</span> <span class="type">list</span>
     * should be one <span class="keyword">of</span> <span class="keyword">the</span> following:
     *
     * &lt;ul&gt;
     * &lt;li&gt;JAR/ZIP/APK files, possibly containing a <span class="string">"classes.dex"</span> <span class="type">file</span> <span class="keyword">as</span>
     * well <span class="keyword">as</span> arbitrary resources.
     * &lt;li&gt;Raw <span class="string">".dex"</span> files (<span class="keyword">not</span> inside a zip <span class="type">file</span>).
     * &lt;/ul&gt;
     *
     * The entries <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">second</span> <span class="type">list</span> should be directories containing
     * native library files.
     *
     * @param dexPath <span class="keyword">the</span> <span class="type">list</span> <span class="keyword">of</span> jar/apk files containing classes <span class="keyword">and</span>
     * resources, delimited <span class="keyword">by</span> {@code File.pathSeparator}, which
     * defaults <span class="keyword">to</span> {@code <span class="string">":"</span>} <span class="function_start"><span class="keyword">on</span></span> Android
     * @param libraryPath <span class="keyword">the</span> <span class="type">list</span> <span class="keyword">of</span> directories containing native
     * libraries, delimited <span class="keyword">by</span> {@code File.pathSeparator}; may be
     * {@code null}
     * @param parent <span class="keyword">the</span> parent <span class="type">class</span> loader
     */
    public PathClassLoader(String dexPath, String libraryPath,
            ClassLoader parent) {
        super(dexPath, null, libraryPath, parent);
      }
    }
</code></pre><p>上面部分是PathClassLoader，看上去好像差不多，但是回到BaseDexClassLoader看一下，发现PathClassLoader是没有传入optimizedDirectory这个变量的。<br>再看下解释：@param optimizedDirectory directory where optimized dex files should be written; may be {@code null}<br>也就是说，这个路径传递的是文件的解压路径。</p>
<pre><code>/<span class="keyword">*</span><span class="keyword">*</span>
 <span class="keyword">*</span> Constructs an instance.
 <span class="keyword">*</span>
 <span class="keyword">*</span> <span class="comment">@param dexPath the list of jar/apk files containing classes and</span>
 <span class="keyword">*</span> resources, delimited by {<span class="comment">@code File.pathSeparator}, which</span>
 <span class="keyword">*</span> defaults to {<span class="comment">@code ":"} on Android</span>
 <span class="keyword">*</span> <span class="comment">@param optimizedDirectory directory where optimized dex files</span>
 <span class="keyword">*</span> should be written; may be {<span class="comment">@code null}</span>
 <span class="keyword">*</span> <span class="comment">@param libraryPath the list of directories containing native</span>
 <span class="keyword">*</span> libraries, delimited by {<span class="comment">@code File.pathSeparator}; may be</span>
 <span class="keyword">*</span> {<span class="comment">@code null}</span>
 <span class="keyword">*</span> <span class="comment">@param parent the parent class loader</span>
 <span class="keyword">*</span>/
public BaseDexClassLoader(String dexPath, File optimizedDirectory,
        String libraryPath, ClassLoader parent) {
    super(parent);
    this.pathList = new DexPathList(this, dexPath, libraryPath, optimizedDirectory);
}
</code></pre><p>再看DexPathList<br>当optimizedDirectory为空时</p>
<pre><code><span class="comment">/**
 * Constructs an instance.
 *
 * @param definingContext the context in which any as-yet unresolved
 * classes should be defined
 * @param dexPath list of dex/resource path elements, separated by
 * {@code File.pathSeparator}
 * @param libraryPath list of native library directory path elements,
 * separated by {@code File.pathSeparator}
 * @param optimizedDirectory directory where optimized {@code .dex} files
 * should be found and written to, or {@code null} to use the default
 * system directory for same
 */</span>
<span class="keyword">public</span> DexPathList(ClassLoader definingContext, String dexPath,
        String libraryPath, <span class="keyword">File</span> optimizedDirectory) {
    <span class="keyword">if</span> (definingContext == <span class="keyword">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"definingContext == null"</span>);
    }

    <span class="keyword">if</span> (dexPath == <span class="keyword">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"dexPath == null"</span>);
    }

    <span class="keyword">if</span> (optimizedDirectory != <span class="keyword">null</span>) {
        <span class="keyword">if</span> (!optimizedDirectory.exists())  {
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(
                    <span class="string">"optimizedDirectory doesn't exist: "</span>
                    + optimizedDirectory);
        }

        <span class="keyword">if</span> (!(optimizedDirectory.canRead()
                        &amp;&amp; optimizedDirectory.canWrite())) {
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(
                    <span class="string">"optimizedDirectory not readable/writable: "</span>
                    + optimizedDirectory);
        }
    }

    <span class="keyword">this</span>.definingContext = definingContext;
    ArrayList&lt;IOException&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;IOException&gt;();
    <span class="keyword">this</span>.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,
                                       suppressedExceptions);
    <span class="keyword">if</span> (suppressedExceptions.<span class="keyword">size</span>() &gt; <span class="number">0</span>) {
        <span class="keyword">this</span>.dexElementsSuppressedExceptions =
            suppressedExceptions.toArray(<span class="keyword">new</span> IOException[suppressedExceptions.<span class="keyword">size</span>()]);
    } <span class="keyword">else</span> {
        dexElementsSuppressedExceptions = <span class="keyword">null</span>;
    }
    <span class="keyword">this</span>.nativeLibraryDirectories = splitLibraryPath(libraryPath);
}


    <span class="comment">/**
     * Makes an array of dex/resource path elements, one per element of
     * the given array.
     */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(ArrayList&lt;<span class="keyword">File</span>&gt; files, <span class="keyword">File</span> optimizedDirectory,
                                             ArrayList&lt;IOException&gt; suppressedExceptions) {
        ArrayList&lt;Element&gt; elements = <span class="keyword">new</span> ArrayList&lt;Element&gt;();
        <span class="comment">/*
         * Open all files and load the (direct or contained) dex files
         * up front.
         */</span>
        <span class="keyword">for</span> (<span class="keyword">File</span> <span class="keyword">file</span> : files) {
            <span class="keyword">File</span> zip = <span class="keyword">null</span>;
            DexFile dex = <span class="keyword">null</span>;
            String name = <span class="keyword">file</span>.getName();

            <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) {
                <span class="comment">// Raw dex file (not inside a zip/jar).</span>
                <span class="keyword">try</span> {
                    dex = loadDexFile(<span class="keyword">file</span>, optimizedDirectory);
                } <span class="keyword">catch</span> (IOException ex) {
                    System.logE(<span class="string">"Unable to load dex file: "</span> + <span class="keyword">file</span>, ex);
                }
            } <span class="keyword">else</span> <span class="keyword">if</span> (name.endsWith(APK_SUFFIX) || name.endsWith(JAR_SUFFIX)
                    || name.endsWith(ZIP_SUFFIX)) {
                zip = <span class="keyword">file</span>;

                <span class="keyword">try</span> {
                    dex = loadDexFile(<span class="keyword">file</span>, optimizedDirectory);
                } <span class="keyword">catch</span> (IOException suppressed) {
                    <span class="comment">/*
                     * IOException might get thrown "legitimately" by the DexFile constructor if the
                     * zip file turns out to be resource-only (that is, no classes.dex file in it).
                     * Let dex == null and hang on to the exception to add to the tea-leaves for
                     * when findClass returns null.
                     */</span>
                    suppressedExceptions.add(suppressed);
                }
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">file</span>.isDirectory()) {
                <span class="comment">// We support directories for looking up resources.</span>
                <span class="comment">// This is only useful for running libcore tests.</span>
                elements.add(<span class="keyword">new</span> Element(<span class="keyword">file</span>, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));
            } <span class="keyword">else</span> {
                System.logW(<span class="string">"Unknown file type for: "</span> + <span class="keyword">file</span>);
            }

            <span class="keyword">if</span> ((zip != <span class="keyword">null</span>) || (dex != <span class="keyword">null</span>)) {
                elements.add(<span class="keyword">new</span> Element(<span class="keyword">file</span>, <span class="keyword">false</span>, zip, dex));
            }
        }

        <span class="keyword">return</span> elements.toArray(<span class="keyword">new</span> Element[elements.<span class="keyword">size</span>()]);
    }
</code></pre><p>makeDexElements将没有返回而直接加载dexPath下的文件，路径下的dex = loadDexFile(file, optimizedDirectory);</p>
<p>以上给出的结论是，这两个方法中， PathClassLoader只能加载解压之后的dex文件，而DexClassLoader 能加载指定路径下的dex/jar/zip/apk中的类，并且还会妥妥地帮你解压。</p>
<p>所以在API说明中如下：<br>DexClassLoader</p>
<p>A class loader that loads classes from .jar and .apk files containing a classes.dex entry. This can be used to execute code not installed as part of an application.<br>This class loader requires an application-private, writable directory to cache optimized classes. Use Context.getCodeCacheDir() to create such a directory:<br>   File dexOutputDir = context.getCodeCacheDir();</p>
<p>Do not cache optimized classes on external storage. External storage does not provide access controls necessary to protect your application from code injection attacks.</p>
<p>来自 <a href="http://developer.android.com/reference/dalvik/system/DexClassLoader.html" target="_blank" rel="external">http://developer.android.com/reference/dalvik/system/DexClassLoader.html</a></p>
<p>PathClassLoader</p>
<p>Provides a simple ClassLoader implementation that operates on a list of files and directories in the local file system, but does not attempt to load classes from the network. Android uses this class for its system class loader and for its application class loader(s).</p>
<p>来自 <a href="http://developer.android.com/reference/dalvik/system/PathClassLoader.html" target="_blank" rel="external">http://developer.android.com/reference/dalvik/system/PathClassLoader.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-无法使用getExternalStorageDirectory" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/27/无法使用getExternalStorageDirectory/" class="article-date">
  	<time datetime="2015-08-27T08:24:54.784Z" itemprop="datePublished">2015-08-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/27/无法使用getExternalStorageDirectory/">android.uid.system 权限应用无法使用getExternalStorageDirectory</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>系统应用目前是被限制随意使用存储权限的，故Environment.getExternalStorageDirectory()这个方法是被限制的</p>
<p>./base/core/java/android/os/Environment.java 中此方法的实现是：</p>
<pre><code><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">File <span class="title">getExternalStorageDirectory</span><span class="params">()</span> </span>{
 throwIfSystem();
 <span class="function"><span class="keyword">return</span> sCurrentUser.<span class="title">getExternalStorageDirectory</span><span class="params">()</span></span>;
}
</code></pre><p>其中：</p>
<pre><code><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">throwIfSystem</span><span class="params">()</span> </span>{
   <span class="keyword">if</span> (Process.myUid() == Process.SYSTEM_UID) {
         Log.wtf(TAG, <span class="string">"Static storage paths aren't available from AID_SYSTEM"</span>, <span class="keyword">new</span> Throwable());
   }
}
</code></pre><p>将被抛出Throwable，这里是无视其他权限声明的，只要是系统的uid就直接异常</p>
<p>解决方案：<br>1、直接写入目录地址，不通过系统方法获取：既然都是系统应用了，那么路径你就应该可以知道<br>2、把getExternalStorageDirectory方法给改了，忽略这个异常<br>3、使用</p>
<pre><code><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">UserEnvironment</span> {
     <span class="function"><span class="keyword">public</span> File <span class="title">getExternalStorageDirectory</span>(<span class="params"></span>) </span>{
                       <span class="keyword">return</span> mExternalStorage;
    }
}
</code></pre><p>中的方法，不过这个类是隐藏的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-LeakCanary的内存泄露检测" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/26/LeakCanary的内存泄露检测/" class="article-date">
  	<time datetime="2015-08-26T14:26:32.759Z" itemprop="datePublished">2015-08-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/26/LeakCanary的内存泄露检测/">LeakCanary的内存泄露检测</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/square/leakcanary" target="_blank" rel="external">https://github.com/square/leakcanary</a><br>一个为android及java提供的内存泄露检测库</p>
<p>Eclipse版本：<a href="https://github.com/SOFTPOWER1991/LeakcanarySample-Eclipse" target="_blank" rel="external">https://github.com/SOFTPOWER1991/LeakcanarySample-Eclipse</a><br>详情见Readme</p>
<p>官方使用文档的翻译：<a href="http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/" target="_blank" rel="external">http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/</a></p>
<p>另外一篇文档：<a href="http://www.liaohuqiu.net/cn/posts/leak-canary/" target="_blank" rel="external">http://www.liaohuqiu.net/cn/posts/leak-canary/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Android系统多窗口实现记录" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/18/Android系统多窗口实现记录/" class="article-date">
  	<time datetime="2015-08-18T12:43:27.556Z" itemprop="datePublished">2015-08-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/18/Android系统多窗口实现记录/">Android系统多窗口实现记录</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Tieto 的实现，在android4.0移植成功，但是应用分辨率适配有问题，支持分屏，有开源代码和PPT<br><a href="http://blog.csdn.net/innost/article/details/17324753" target="_blank" rel="external">http://blog.csdn.net/innost/article/details/17324753</a></p>
<p>讲解了android4.4自带的分屏效果，试验可以，但是在我们的RK平台上有缺陷<br><a href="http://blog.csdn.net/ritterliu/article/details/37560239" target="_blank" rel="external">http://blog.csdn.net/ritterliu/article/details/37560239</a></p>
<p>上文的同一个作者，还没有开始移植代码，支持多窗口，但是应该和第一个Tieto有类似问题<br><a href="http://blog.csdn.net/ritterliu/article/details/32699125" target="_blank" rel="external">http://blog.csdn.net/ritterliu/article/details/32699125</a></p>
<p>这里有一家实现多窗口比较好的产品，买了样品<br><a href="http://www.jide.com/remixos" target="_blank" rel="external">http://www.jide.com/remixos</a></p>
<p>预计未来android会支持多窗口机制，如果需要自己实现，预计需要研究一下问题</p>
<p>1、android窗口机制的实现原理<br>2、触摸等输入事件的处理<br>3、Stack的处理<br>4、生命周期的控制<br>5、应用适配与切换</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-最近读的书" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/13/最近读的书/" class="article-date">
  	<time datetime="2015-08-13T14:53:49.463Z" itemprop="datePublished">2015-08-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/13/最近读的书/">最近读的一些书</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近读了很多杂书。<br>小说类的，读完了《山海经密码》，有莘同志浴火；顺便读着《镜花缘》，想着小时候看过的这个电视剧。<br>上次回潮汕的高铁上读的是《乌合之众》，读出了一些负能量；然后看了Python的一些语法，开始学一点其他编程语言<br>陆陆续续地把KPW3里面的书更新了一轮，回头去看几本旧书，《盗墓笔记》看到了南海海底墓，《明朝那些事》看到了朱允炆和他四叔开始撕破脸皮。<br>现在太硬的书啃不下去，太轻的书觉得是浪费时间。只能说是慢慢读书，大概也就这样子。<br>办公室桌面还有一些杂书，和技术书籍放在一起。<br>对了，<br>谁拿了我的《万历十五年》？？</p>
<p>最近有几个计划，想去一下朝鲜，或者去下俄罗斯。<br>没啥人同行（比如说刚刚在背后的同事就说不会跟我去，他要去泡妞）</p>
<p><img src="/img/15-8-book-travel.jpg" alt="出境"></p>
<p>旅游也是读书，比如说上次在斯里兰卡遇到的各种人，比如，这两年都在同一天出境，海关给你改了一个整齐的章。<br>比如说那些美景，记录下来，老了以后和子孙说，这些地方，你老爹当年也去过。<br>回头写博客的时候，能够在一个刚刚写了不久的技术博客里面出现一些美景，也是足够的。</p>
<p>比如说高山火车上那只忧郁的狗。<br><img src="/img/15-8-book-dog.jpg" alt="那只狗"><br>比如说沿着海岸线开的火车，有浪拍来。<br><img src="/img/15-8-book-sea.jpg" alt="火车海岸"></p>
<p>那是一本书。<br>还有一个博客写的是一下琐碎的生活，好久没有更新了，那么你想问上面这些琐碎为什么不放到那个博客呢？<br>  <a href="http://www.chenweilin.com/" title="Title" target="_blank" rel="external">WilliamChen的博客</a>有一些琐碎的记录。</p>
<p>原因是，下面有一段内容是给程序员们用的，也是自己一个学习的借鉴内容。</p>
<p>这两天看到一篇老文章，讲关于程序员需要读的书的，觉得挺有意思，稍微整理了一下：</p>
<p><img src="/img/15-8-book-sw.jpg" alt="软件"></p>
<p>发现自己专业的书还是读的比较少，好长时间被困在业务的各种杂事里面了。</p>
<p>就这样吧…</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-关于语言的一点想法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/10/关于语言的一点想法/" class="article-date">
  	<time datetime="2015-08-10T14:18:05.058Z" itemprop="datePublished">2015-08-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/10/关于语言的一点想法/">关于语言的一点想法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在我的想法避免，比较根深的是：人类大多数时候是用语言来思考的。<br>那么程序员呢？<br>最近在学习Python，发现和我惯用的java有很大的区别。不仅仅是语言，而是思维方式的不同。<br>我越发觉得，多年以后应该有一门语言是专门为了实现而出现的，没有各种gc啥的负担，不需要各种严密的设计，而是仅仅为了设计与实现而出现的。</p>
<blockquote>
<p>待续</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-NFC知识点整理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/03/NFC知识点整理/" class="article-date">
  	<time datetime="2015-08-03T13:46:59.964Z" itemprop="datePublished">2015-08-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/03/NFC知识点整理/">NFC知识点整理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>又开始了愉快的一周，为了准备分享，所以只能趁着现在把之前的一些知识点做下整理<br>首先是写在公司博客的一些内容：<br>1、卡的类型<br>手头供应商为NXP，所以给的卡就是Mifare Classic/Plus/Desfire/UtrilLight，已经基本覆盖所有NXP的卡片类型，剩下的区别就是容量和加密类型区别而已<br>2、关于Classic类型的卡<br>NFC芯片存在一个EEPROM的区域，里面分为了几个区域，我们通过指令进行不同区域的读写加密<br>3、关于工卡<br>某厂工卡使用Classic类型的卡片，此类型卡已经有专门破解的硬件了。<br>已经能够批量复制工卡。<br>4、涉及的协议：ISO/IEC 14443A（1~4），ISO 7816（APDU，此为命令），部分卡片或者读卡器会有一些私有的指令<br>5、安全，Plus S使用AES，Desfire也有更高级的加密，其他的即使有也形同虚设。银行卡级别的使用了一个叫做SE的加密模块，这个需要硬件支持。目前用在sim卡、银行卡等场景<br>6、能否用NFC Android模拟一张卡？<br>这个叫做HCE(Host-based Card Emulation) ，Android4.4后支持，但支持的协议仅有： ISO/IEC 7816-4 over ISO-DEP (ISO/IEC 14443-4)<br>此处有一老外的回答：</p>
<p>Speculations on why they decided that way:</p>
<p>First of all, ISO/IEC 7816-4 over ISO-DEP is the highes protocol layer that could be used to route communication to the application processor through NCI (NFC Controller Interface). Routing lower protocol layers is possible (read: “the NCI protocol supports this”), though there is no need for the NFC controller to even support routing of lower layer communication.<br>ISO/IEC 7816-4 over ISO-DEP permits routing on a per-application basis. I.e. the reader selects a specific application and only then, the NFC controller decides if the communication is passed to a secure element or to the application processor. The application processor can perform a similar routing mechanism to route communication to a specific app (that’s what’s done on Android now).<br>Using lower protocol layers (e.g. ISO/IEC 14443-3) there is no way of doing per-application routing. Instead all communication on that level would be routed to either a secure element or to the application processor. If routed to the application processor, then the operating system has no means to choose between multiple apps. Instead only one app could be registered for that type of communication. However, considering the multitude of app developers for a platform like Android, permitting only a single app would be rather inhibiting development.<br>MIFARE Classic is proprietary technology from NXP. I don’t expect them to license a pure software implementation (on the application processor/Android system) of the MIFARE Classic protocol/tag platform.<br>MIFARE Classic uses non-standard framing for authentication commands, so it might be difficult to emulate over the NCI Frame RF interface (though I’m not sufficiently familiar with that protocol to confirm if there’s an actual limitation that prevents MF Classic emulation).</p>
<p>简而言之，Google家只想支持最新的协议的卡片，classic之类的就算了吧</p>
<p>7、项目的最后产生了一个库，现在只能支持mifare S50的，后续陆续支持其他卡片<br>8、一个可以界面的项目：<a href="https://github.com/ikarus23/MifareClassicTool" target="_blank" rel="external">https://github.com/ikarus23/MifareClassicTool</a><br>9、一些android不支持的卡片，可以通过用java重写一遍该卡片的linux驱动来实现，和当年重新BLE的协议代码一样，想想当年，还真可怜，还好这次需求没说要支持</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-android事件注入" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/02/android事件注入/" class="article-date">
  	<time datetime="2015-08-02T08:46:48.355Z" itemprop="datePublished">2015-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/android事件注入/">android事件注入</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>另外一个伤感的问题，测试的同学发现了一个概率性问题。<br>OK，那就抓Log，发现是那个RandomAccessFile抛出IO Exception<br>那就在挂掉的地方重新来一次呗，改完<br>如何测试？？？<br>本来切通道和唤出菜单都是有广播和按键事件可以利用的，写了一个小小的服务。<br>后来想起，实际上可以通过sendevent /dev/input/event0 进行模拟、按键事件的注入，随查询了一下abs的代码，发现一点坑的问题，这个语法太复杂<br>举例：</p>
<pre><code><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span>   ABS_MT_TOUCH_MAJOR = <span class="string">"0x30"</span>; <span class="comment">/* Major axis of touching ellipse */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_TOUCH_MINOR = <span class="string">"0x31"</span>; <span class="comment">/* Minor axis (omit if circular) */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_WIDTH_MAJOR = <span class="string">"0x32"</span>; <span class="comment">/* Major axis of approaching ellipse */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_WIDTH_MINOR = <span class="string">"0x33"</span>; <span class="comment">/* Minor axis (omit if circular) */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_ORIENTATION = <span class="string">"0x34"</span>; <span class="comment">/* Ellipse orientation */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_POSITION_X = <span class="string">"0x35"</span>;<span class="comment">/* Center X ellipse position */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_POSITION_Y = <span class="string">"0x36"</span>; <span class="comment">/* Center Y ellipse position */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_TOOL_TYPE = <span class="string">"0x37"</span>; <span class="comment">/* Type of touching device (finger, pen, ...) */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_BLOB_ID = <span class="string">"0x38"</span>; <span class="comment">/* Group a set of packets as a blob */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_TRACKING_ID = <span class="string">"0x39"</span>; <span class="comment">/* Unique ID of initiated contact */</span>
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> ABS_MT_PRESSURE = <span class="string">"0x3a"</span>; <span class="comment">/* Pressure on contact area */</span>
</code></pre><p>以上是ABS事件的所有命令，后面查了一下一篇文章<br><a href="http://blog.csdn.net/xbalien29/article/details/12977047" target="_blank" rel="external">http://blog.csdn.net/xbalien29/article/details/12977047</a></p>
<pre><code><span class="number">0003</span> <span class="number">0035</span> <span class="number">0000008</span>b
<span class="number">0003</span> <span class="number">0036</span> <span class="number">000002</span>c0
<span class="number">0003</span> <span class="number">0030</span> <span class="number">00000044</span>
<span class="number">0003</span> <span class="number">0032</span> <span class="number">00000004</span>
<span class="number">0003</span> <span class="number">0039</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0002</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0000</span> <span class="number">00000000</span>
<span class="number">0003</span> <span class="number">0035</span> <span class="number">0000008</span>b
<span class="number">0003</span> <span class="number">0036</span> <span class="number">000002</span>c0
<span class="number">0003</span> <span class="number">0030</span> <span class="number">00000000</span>
<span class="number">0003</span> <span class="number">0032</span> <span class="number">00000001</span>
<span class="number">0003</span> <span class="number">0039</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0002</span> <span class="number">00000000</span>
<span class="number">0000</span> <span class="number">0000</span> <span class="number">00000000</span>
</code></pre><p>这是一个点击事件的命令！<br>开动大脑，开始读Monkey代码：/development/cmds/monkey<br>这是一份还不错的代码，实际上是采用了IWindowManager中的injectKeyEvent等方法，同样的，触摸事件是通过类似的injectMotionEvent实现。<br>随之，抽离代码<br>形成了一个库，给后来人调用<br>写了一个服务，不断地帮我点击某个地方，按按键。<br>至于背后的方法injectKeyEvent在系统中是如何注入的呢？且听下回分解<br>我那跑了一夜的代码</p>
<pre><code><span class="comment">/**
 * @file SwitchService.java
 * @author chenweilin
 * @brief  触摸和按键模拟服务
 * @date 2015-7-15 create
 *
 */</span>
<span class="keyword">public</span> <span class="keyword">class</span> DemoService extends Service {
    @<span class="function">Override
    <span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent arg0)</span> </span>{
        <span class="keyword">return</span> null;
    }

    <span class="keyword">private</span> <span class="keyword">int</span> mVerbose = <span class="number">1</span>;
    <span class="keyword">private</span> IActivityManager mAm;
    <span class="keyword">private</span> IWindowManager mWm;
    <span class="keyword">private</span> Random mRandom;


    @<span class="function">Override
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>{
        super.onCreate();
        getSystemInterfaces();
        mRandom = <span class="keyword">new</span> Random();
        SwitchThread switchThread = <span class="keyword">new</span> SwitchThread();
        switchThread.start();
    }
    <span class="keyword">class</span> SwitchThread extends Thread {
        @<span class="function">Override
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{
            <span class="keyword">while</span> (<span class="literal">true</span>) {
                callTouchMenuAndClick(<span class="number">408</span>,<span class="number">303</span>);<span class="comment">//点击某个地方</span>
                callTouchMenuAndClick(<span class="number">471</span>,<span class="number">296</span>);<span class="comment">//点击某个地方</span>
                callTouchMenuAndClick(<span class="number">535</span>,<span class="number">296</span>);<span class="comment">//点击某个地方</span>
            }
        }
    }


    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callTouchMenuAndClick</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>{
        <span class="keyword">int</span> time = mRandom.nextInt(<span class="number">1500</span>)%(<span class="number">1500</span>-<span class="number">700</span>+<span class="number">1</span>) + <span class="number">700</span>;<span class="comment">//点击间隔时间随机</span>
        injectKeyDown(KeyEvent.KEYCODE_TV_INPUT);
        <span class="keyword">try</span> {
            Thread.sleep(time);
        } <span class="keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        injectClick(x, y);
        time = mRandom.nextInt(<span class="number">10000</span>)%(<span class="number">10000</span>-<span class="number">4000</span>+<span class="number">1</span>) + <span class="number">4000</span>;
        <span class="keyword">try</span> {
            Thread.sleep(time);
        } <span class="keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }


    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectClick</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>{
        MonkeyTouchEvent monkeyTouchEvent = <span class="keyword">new</span> MonkeyTouchEvent(MotionEvent.ACTION_DOWN);
        monkeyTouchEvent.addPointer(<span class="number">0</span>, x, y);
        monkeyTouchEvent.injectEvent(mWm, mAm, mVerbose);
        <span class="keyword">try</span> {
            Thread.sleep(<span class="number">200</span>);
        } <span class="keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        monkeyTouchEvent = <span class="keyword">new</span> MonkeyTouchEvent(MotionEvent.ACTION_UP);
        monkeyTouchEvent.addPointer(<span class="number">0</span>, x, y);
        monkeyTouchEvent.injectEvent(mWm, mAm, mVerbose);
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">injectKeyDown</span><span class="params">(<span class="keyword">int</span> keycode)</span></span>{
        MonkeyKeyEvent monkeyKeyEvent = <span class="keyword">new</span> MonkeyKeyEvent(KeyEvent.ACTION_DOWN, keycode);
        monkeyKeyEvent.injectEvent(mWm, mAm, mVerbose);
    }

    <span class="function"><span class="keyword">private</span> boolean <span class="title">getSystemInterfaces</span><span class="params">()</span> </span>{
        mAm = ActivityManagerNative.getDefault();
        <span class="keyword">if</span> (mAm == null) {
            System.err.println(<span class="string">"** Error: Unable to connect to activity manager; is the system "</span>
                    + <span class="string">"running?"</span>);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        mWm = IWindowManager.Stub.asInterface(ServiceManager.getService(<span class="string">"window"</span>));
        <span class="keyword">if</span> (mWm == null) {
            System.err.println(<span class="string">"** Error: Unable to connect to window manager; is the system "</span>
                    + <span class="string">"running?"</span>);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
    }
}
</code></pre><p>Monkey中的实现</p>
<pre><code>@<span class="function">Override
<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">injectEvent</span>(<span class="params">IWindowManager iwm, IActivityManager iam, <span class="keyword">int</span> verbose</span>) </span>{
    <span class="keyword">if</span> (verbose &gt; <span class="number">1</span>) {
        String note;
        <span class="keyword">if</span> (mAction == KeyEvent.ACTION_UP) {
            note = <span class="string">"ACTION_UP"</span>;
        } <span class="keyword">else</span> {
            note = <span class="string">"ACTION_DOWN"</span>;
        }
        <span class="keyword">try</span> {
            System.<span class="keyword">out</span>.println(<span class="string">":Sending Key ("</span> + note + <span class="string">"): "</span>
                    + mKeyCode + <span class="string">"    // "</span>
                    + MonkeySourceRandom.getKeyName(mKeyCode));
        } <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
            System.<span class="keyword">out</span>.println(<span class="string">":Sending Key ("</span> + note + <span class="string">"): "</span>
                    + mKeyCode + <span class="string">"    // Unknown key event"</span>);
        }
    }
    <span class="comment">// inject key event</span>
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (!iwm.injectKeyEvent(getEvent(), <span class="keyword">false</span>)) {<span class="comment">//这里背后应该有另外一篇博文产出，需要读系统源码了</span>
            <span class="keyword">return</span> MonkeyEvent.INJECT_FAIL;
        }
    } <span class="keyword">catch</span> (RemoteException ex) {
        <span class="keyword">return</span> MonkeyEvent.INJECT_ERROR_REMOTE_EXCEPTION;
    }
    <span class="keyword">return</span> MonkeyEvent.INJECT_SUCCESS;
}
</code></pre><p>后记：<br>实际上可以写一个简单的脚本进行事件的注入，实现自动化测试<br>所以，这就成了给实习生玩的一个项目</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-adb源码初读" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/02/adb源码初读/" class="article-date">
  	<time datetime="2015-08-02T08:27:48.651Z" itemprop="datePublished">2015-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/adb源码初读/">adb源码初读</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先上一张图片，这是adb通信的时候的主要模块</p>
<p><img src="/img/15-8-adb_main.png" alt="adb_main"></p>
<p>Host即主机，在实际操作中，可以把电脑，android主机当做Host，使用adb命令连接即可<br>主机内会开启一个Server，通过TCP进行内部的通信，adb-client即用户输入界面之类的。而客户端中跑的是一个叫做adbd的东西，全称是：adb daemon 在android设备端的守护进程，看源码可以发现这货是随整机启动的。<br>下面是源码走读时间：路径位于：/system/core/adb，大家可以看到一些奇怪的标签ADB_HOST。。aha。。区分主从应用所用。。。先mm一番，会发现编译会生成主机端和客户端两个可执行文件：</p>
<pre><code><span class="string">Install:</span> out<span class="regexp">/target/</span>product<span class="regexp">/seewo/</span>system<span class="regexp">/bin/</span>adb 主机端的bin，可以直接在电脑执行
<span class="string">Install:</span> out<span class="regexp">/target/</span>product<span class="regexp">/seewo/</span>root<span class="regexp">/sbin/</span>adbd 客户端守护进程的bin
</code></pre><p>那么，如何解决通信问题呢？<br>看源码：commandline.c 这里就是处理Host端指令的地方，问我为什么知道？看mk文件，然后顺着读下来就行了。</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">adb_commandline</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>{

}
</code></pre><p>举例：</p>
<pre><code><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"connect"</span>)) {
        <span class="keyword">char</span> *tmp;
        <span class="keyword">if</span> (argc != <span class="number">2</span>) {
            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: adb connect &lt;host&gt;[:&lt;port&gt;]\n"</span>);
            <span class="keyword">return</span> <span class="number">1</span>;
        }
        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span> buf, <span class="string">"host:connect:%s"</span>, argv[<span class="number">1</span>]);
        tmp = adb_query(buf);
        <span class="keyword">if</span>(tmp) {
            <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, tmp);
            <span class="keyword">return</span> <span class="number">0</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="number">1</span>;
        }
    }
</code></pre><p>  //我试着写了一个，效果杠杠的</p>
<p>这里进行连接的判断<br>既然我们需要进行信息交换，那么类似的有adb logcat ，看这部分代码</p>
<pre><code><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"logcat"</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"lolcat"</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"longcat"</span>)) {
    <span class="keyword">return</span> logcat(ttype, serial, argc, argv);
}
</code></pre><p>// 之后是</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">logcat</span><span class="params">(transport_type transport, <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span>
</span>{
    <span class="keyword">char</span> buf[<span class="number">4096</span>];
    <span class="keyword">char</span> *log_tags;
    <span class="keyword">char</span> *quoted_log_tags;
    log_tags = getenv(<span class="string">"ANDROID_LOG_TAGS"</span>);
    quoted_log_tags = dupAndQuote(log_tags == <span class="literal">NULL</span> ? <span class="string">""</span> : log_tags);
    <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf),
        <span class="string">"shell:export ANDROID_LOG_TAGS=\"\%s\" ; exec logcat"</span>,
        quoted_log_tags);
    <span class="built_in">free</span>(quoted_log_tags);
    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"longcat"</span>)) {
        <span class="built_in">strncat</span>(buf, <span class="string">" -v long"</span>, <span class="keyword">sizeof</span>(buf)-<span class="number">1</span>);
    }
    argc -= <span class="number">1</span>;
    argv += <span class="number">1</span>;
    <span class="keyword">while</span>(argc-- &gt; <span class="number">0</span>) {
        <span class="keyword">char</span> *quoted;
        quoted = dupAndQuote (*argv++);
        <span class="built_in">strncat</span>(buf, <span class="string">" "</span>, <span class="keyword">sizeof</span>(buf)-<span class="number">1</span>);
        <span class="built_in">strncat</span>(buf, quoted, <span class="keyword">sizeof</span>(buf)-<span class="number">1</span>);
        <span class="built_in">free</span>(quoted);
    }
    send_shellcommand(transport, serial, buf);<span class="comment">//实际最终执行的地方</span>
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>//之后是：</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">send_shellcommand</span><span class="params">(transport_type transport, <span class="keyword">char</span>* serial, <span class="keyword">char</span>* buf)</span>
</span>{
    <span class="keyword">int</span> fd, ret;
    <span class="keyword">for</span>(;;) {
        fd = adb_connect(buf);<span class="comment">//如果没连接则等待设备</span>
        <span class="keyword">if</span>(fd &gt;= <span class="number">0</span>)
            <span class="keyword">break</span>;
        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"- waiting for device -\n"</span>);<span class="comment">//是不是觉得这句话很眼熟</span>
        adb_sleep_ms(<span class="number">1000</span>);
        do_cmd(transport, serial, <span class="string">"wait-for-device"</span>, <span class="number">0</span>);<span class="comment">//真的去等设备了，等到心碎，而且会滚回去开头的那个函数</span>
    }
    read_and_dump(fd);<span class="comment">//重点来了，后面读这里</span>
    ret = adb_close(fd);
    <span class="keyword">if</span> (ret)
        perror(<span class="string">"close"</span>);
    <span class="keyword">return</span> ret;
}
</code></pre><p>//读取Log的地方</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read_and_dump</span><span class="params">(<span class="keyword">int</span> fd)</span>
</span>{
    <span class="keyword">char</span> buf[<span class="number">4096</span>];
    <span class="keyword">int</span> len;
    <span class="keyword">while</span>(fd &gt;= <span class="number">0</span>) {
        D(<span class="string">"read_and_dump(): pre adb_read(fd=%d)\n"</span>, fd);<span class="comment">//可以尝试把这个打印打开，你就知道怎么回事了</span>
        len = adb_read(fd, buf, <span class="number">4096</span>);<span class="comment">//实际上还是读取USB设备写过来的数据</span>
        D(<span class="string">"read_and_dump(): post adb_read(fd=%d): len=%d\n"</span>, fd, len);
        <span class="keyword">if</span>(len == <span class="number">0</span>) {
            <span class="keyword">break</span>;
        }
        <span class="keyword">if</span>(len &lt; <span class="number">0</span>) {
            <span class="keyword">if</span>(errno == EINTR) <span class="keyword">continue</span>;
            <span class="keyword">break</span>;
        }
        fwrite(buf, <span class="number">1</span>, len, <span class="built_in">stdout</span>);
        fflush(<span class="built_in">stdout</span>);
    }
}
</code></pre><p>这个时候问题来了，如何实现从设备向主设备发送消息呢？</p>
<pre><code>adb Logcat <span class="operator">-s</span> “something”
</code></pre><p>over</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/02/hello-world/" class="article-date">
  	<time datetime="2015-08-02T07:05:42.698Z" itemprop="datePublished">2015-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/02/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 WilliamChen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>